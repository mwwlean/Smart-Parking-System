<!DOCTYPE html>
<html>
<head>
    <title>QR Code Scanner</title>
</head>
<body>
    <h1>QR Code Scanner</h1>
    
    <div id="scanner-container">
        <img id="video" src="{{ url_for('video_feed') }}">
        <div id="scan-box"></div>
    </div>
    
    <div id="result">
        <h2 id="status-message"></h2>
        <div id="user-info" class="user-info"></div>
    </div>
    
    <div class="action-buttons">
        <button id="scan-again" style="display:none;">Scan Another</button>
        <button id="back-to-dashboard">Back to Dashboard</button>
    </div>
    
    <script>
        const video = document.getElementById('video');
        const resultDiv = document.getElementById('result');
        const statusMessage = document.getElementById('status-message');
        const userInfo = document.getElementById('user-info');
        const scanAgainBtn = document.getElementById('scan-again');
        const backBtn = document.getElementById('back-to-dashboard');
        
        // QR code detection
        const qrWorker = new Worker("{{ url_for('static', filename='js/qr-scanner-worker.js') }}");
        
        // Get canvas for QR detection
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas dimensions to match video
        function updateCanvasSize() {
            canvas.width = video.videoWidth || video.clientWidth;
            canvas.height = video.videoHeight || video.clientHeight;
        }
        
        // Scan for QR codes periodically
        let scanInterval = setInterval(() => {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                updateCanvasSize();
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                qrWorker.postMessage(imageData);
            }
        }, 500);
        
        // Handle QR code detection
        qrWorker.onmessage = function(e) {
            if (e.data && e.data.length > 0) {
                // Found a QR code - stop scanning and process
                clearInterval(scanInterval);
                processQRCode(e.data[0]);
            }
        };
        
        // Process the scanned QR code
        function processQRCode(code) {
            fetch("{{ url_for('process_scan') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ code: code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.style.display = 'block';
                    
                    if (data.status === 'ENTRY') {
                        resultDiv.className = 'entry';
                        statusMessage.textContent = 'ENTRY LOGGED';
                    } else {
                        resultDiv.className = 'exit';
                        statusMessage.textContent = 'EXIT LOGGED';
                    }
                    
                    userInfo.innerHTML = `
                        <p><strong>User:</strong> ${data.user}</p>
                        <p><strong>Location:</strong> ${data.location}</p>
                    `;
                    
                    scanAgainBtn.style.display = 'inline-block';
                } else {
                    resultDiv.style.display = 'block';
                    resultDiv.className = 'error';
                    statusMessage.textContent = 'ERROR';
                    userInfo.innerHTML = `<p>${data.message}</p>`;
                    scanAgainBtn.style.display = 'inline-block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                resultDiv.style.display = 'block';
                resultDiv.className = 'error';
                statusMessage.textContent = 'ERROR';
                userInfo.innerHTML = '<p>Failed to process QR code</p>';
                scanAgainBtn.style.display = 'inline-block';
            });
        }
        
        // Button event handlers
        scanAgainBtn.addEventListener('click', () => {
            resultDiv.style.display = 'none';
            scanAgainBtn.style.display = 'none';
            scanInterval = setInterval(() => {
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    updateCanvasSize();
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    qrWorker.postMessage(imageData);
                }
            }, 500);
        });
        
        backBtn.addEventListener('click', () => {
            window.location.href = "{{ url_for('admin_dashboard') }}";
        });
    </script>
</body>
</html>